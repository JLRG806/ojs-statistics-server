<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<div class="container rounded mx-auto shadow-xl p-3">

    <!-- Input Number -->
    <div class="bg-white border border-gray-200 rounded-lg w-fit">
        <div class="w-full flex justify-between items-center gap-x-1">
            <div class="grow py-2 px-3">
                <span class="w-full p-1 bg-transparent border-0 text-gray-800 focus:ring-0" type="text"
                    value="2025">2025</span>
            </div>
            <div class="flex items-center -gap-y-px divide-x divide-gray-200 border-s border-gray-200">
                <button type="button"
                    class="size-10 inline-flex justify-center items-center gap-x-2 text-sm font-medium last:rounded-e-lg bg-white text-gray-800 hover:bg-gray-50 disabled:opacity-50 disabled:pointer-events-none"
                    data-hs-input-number-decrement="1">
                    <svg class="flex-shrink-0 size-3.5" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M5 12h14"></path>
                    </svg>
                </button>
                <button type="button"
                    class="size-10 inline-flex justify-center items-center gap-x-2 text-sm font-medium last:rounded-e-lg bg-white text-gray-800 hover:bg-gray-50 disabled:opacity-50 disabled:pointer-events-none"
                    data-hs-input-number-increment="1">
                    <svg class="flex-shrink-0 size-3.5" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M5 12h14"></path>
                        <path d="M12 5v14"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <!-- End Input Number -->

    <hr class="border-solid border border-gray-300 rounded my-3 mx-1">

    <button onclick="updateChart('month')">Mes</button>
    <button onclick="updateChart('year')">Año</button>

    <div id="reportranges"
        style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; width: 100%">

        <i class="fa fa-calendar"></i>

        <span id="dateSpan"></span>
        <!-- <input type="text" name="reportrange" id="reportrange" class="appearance-none required:border-red-500"> -->
        <div class="w-60">
            <div class="relative h-10 w-full min-w-[200px]">
                <!-- <i class="material-icons" style="font-size: 1.3rem;">calendar_month</i> -->
                <label for="reportrange" class=""> Test
                    <input type="text" name="reportrange" id="reportrange"
                        class="peer h-full w-full rounded-[7px]  !border  !border-gray-300 border-t-transparent bg-transparent bg-white px-3 py-2.5 font-sans text-sm font-normal text-blue-gray-700  shadow-lg shadow-gray-900/5 outline outline-0 ring-4 ring-transparent transition-all placeholder:text-gray-500 placeholder-shown:border placeholder-shown:border-blue-gray-200 placeholder-shown:border-t-blue-gray-200 focus:border-2  focus:!border-gray-900 focus:border-t-transparent focus:!border-t-gray-900 focus:outline-0 focus:ring-gray-900/10 disabled:border-0 disabled:bg-blue-gray-50" />
                </label>
                <!-- <i class="material-icons" style="font-size: 1.3rem;">expand_more</i> -->
            </div>
        </div>

        <div class="year-selector">
            <label for="year">Select Year:</label>
            <select id="year" class="form-control">
                <!-- Options will be added dynamically -->
            </select>
        </div>
    </div>
    <div class="p-2">
        <canvas id="myChart"></canvas>
    </div>
</div>


<script type="text/javascript">

    class FetchData {

        #url;
        #contextUrl;
        #context;

        constructor() {
            //this.url = window.location.href;
            this.#url = 'http://localhost:8000/stats/issues/timeline?';
            //this.#contextUrl = window.location.href;
            this.#contextUrl = 'https://v2.mls.quimera.internal/index.php/MLS-Law-International-Politics/index';
            this.#context = this.getContext();
        }

        /**
         * Fetch data from the API
         * @async
         * @param {string} dateStart - The start date
         * @param {string} dateEnd - The end date
         * @param {string} timelineInterval - The timeline interval
         * @param {string} type - The type of data to fetch
         * @returns {Promise} - The fetched data
         * @example fetchData('2021-01-01', '2021-12-31', 'month', 'downloads')
         * @example fetchData('2021-01-01', '2021-12-31', 'year', 'views')
         * @example fetchData('2021-01-01', '2021-12-31', 'year', 'downloads')          
        */
        async fetchData(dateStart, dateEnd, timelineInterval, type) {

            const validTypes = ['files', 'views'];
            if (!validTypes.includes(type)) {
                throw new Error('Invalid type');
            }

            if (timelineInterval !== 'month' && timelineInterval !== 'year') {
                throw new Error('Invalid timeline interval');
            }

            if (!dateStart || !dateEnd) {
                throw new Error('Invalid date range');
            }

            try {
                if (type === 'files') {
                    console.log('fetching downloads')

                    const response = await fetch(`${this.#url}${new URLSearchParams({
                        dateStart,
                        dateEnd,
                        timelineInterval,
                        type,
                        context: this.#context
                    })}`,
                        {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': '*/*',
                                'Accept-Encoding': 'gzip, deflate, br',
                            }
                        });
                    const data = await response.json();
                    console.log("Downloads data ->", data);
                    return data;

                } else if (type === 'views') {
                    console.log('fetching views')

                    const response = await fetch(`${this.#url}${new URLSearchParams({
                        dateStart,
                        dateEnd,
                        timelineInterval,
                        context: this.#context
                    })}`,
                        {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': '*/*',
                                'Accept-Encoding': 'gzip, deflate, br',
                            }
                        });
                    const data = await response.json();
                    console.log("Views data ->", data);
                    return data;
                }
            } catch (error) {
                console.error(error);
            }

        }

        getContext() {
            // Crear un objeto URL a partir de la cadena de URL
            const url = new URL(this.#contextUrl);

            // Obtener el pathname de la URL
            const pathname = url.pathname;

            // Dividir el pathname en partes utilizando "/" como delimitador
            const parts = pathname.split('/');
            console.log(parts)

            // Obtener la posición del texto deseado
            const position = 2; // Posición del texto deseado

            // Verificar si la posición es válida
            if (position >= 0 && position < parts.length) {
                // Obtener el texto en la posición especificada
                const resultText = parts[position];
                console.log(`El texto en la posición ${position} es: ${resultText}`);
                return resultText;
            } else {
                console.log(`La posición ${position} no es válida en la URL.`);
                return `La posición ${position} no es válida en la URL.`;
            }
        }
    }

    class DateRangePickerClass {
        constructor(start, end) {
            this.start = start
            this.end = end
        }

        async cb(start, end, thisOne, thatOne) {
            $('#reportrange span').html(start.format('YYYY-MM-DD') + ' - ' + end.format('YYYY-MM-DD'));
            console.log(start.format('YYYY-MM-DD'))
            console.log(end.format('YYYY-MM-DD'))

            const fetchData = new FetchData();
            const downloadsData = await fetchData.fetchData(start.format('YYYY-MM-DD'), end.format('YYYY-MM-DD'), 'month', 'files');
            const viewsData = await fetchData.fetchData(start.format('YYYY-MM-DD'), end.format('YYYY-MM-DD'), 'month', 'views');

            const labels = downloadsData.map(item => item.label);

            const dataDownloads = downloadsData.map(item => item.value);
            const dataViews = viewsData.map(item => item.value);

            updateChart({ labels, dataDownloads, dataViews })
            console.log(downloadsData, viewsData)
            console.log(thisOne, thatOne)

        }

        startDatePicker() {
            $('#reportrange').daterangepicker({
                alwaysShowCalendars: false,
                startDate: this.start,
                endDate: this.end,
                ranges: {
                    'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                    'Last 7 Days': [moment().subtract(6, 'days'), moment().subtract(1, 'days')],
                    'Last 30 Days': [moment().subtract(29, 'days'), moment().subtract(1, 'days')],
                    'This Month': [moment().startOf('month'), moment().subtract(1, 'days')],
                    'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
                    'All Dates': [moment().subtract(10, 'years'), moment().subtract(1, 'days')],
                    'Actual Year': [moment().startOf('year'), moment().subtract(1, 'days')]
                }
            }, this.cb);

            this.cb(this.start, this.end);

            // Populate the year selector
            // var startYear = 2000; // Starting year for the dropdown
            // var endYear = new Date().getFullYear(); // Current year
            // var $yearSelector = $('#year');
            // for (var year = startYear; year <= endYear; year++) {
            //     $yearSelector.append($('<option>', {
            //         value: year,
            //         text: year
            //     }));
            // }

            // Event listener for year selector change
            // $('#year').change(function () {
            //     console.log("year event")
            //     var selectedYear = $(this).val();
            //     $('#dateSpan').val(selectedYear + '-01-01 to ' + selectedYear + '-12-31');
            // });
        }
    }

    // Initialize the date range picker
    $(document).ready(function () {
        console.log("ready!")
        let start = moment().subtract(29, 'days')
        let end = moment().subtract(1, 'days')
        const drp = new DateRangePickerClass(start, end)
        drp.startDatePicker()
    });


    const ctx = document.getElementById('myChart');

    const chart = new Chart(ctx, {
        data: {
            type: 'bar',
            labels: [],
            datasets: [{
                type: 'line',
                label: '# of downloads',
                data: [],
                borderWidth: 2.5,
                backgroundColor: 'rgba(255, 99, 132, 1)',
                borderColor: 'rgba(255, 99, 132, 1)',
            }, {
                type: 'bar',
                label: '',
                data: [],
                borderWidth: 2.5,
                backgroundColor: 'rgba(255, 99, 132, 0)',
                borderColor: 'rgba(255, 99, 132, 0)',
            }, {
                type: 'line',
                label: '# of views',
                data: [],
                borderWidth: 2.5,
                backgroundColor: 'rgba(54, 162, 235, 1)',
                borderColor: 'rgba(54, 162, 235, 1)',
            }
            ]
        },
        options: {
            responsive: true,
            layout: {
                autoPadding: false
            },
            tension: 0.35,
            scales: {
                y: {
                    beginAtZero: false
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    
                }
            }
        }
    });

    const getData = (period) => {
        let labels = [];
        let dataDownloads = [];
        let dataViews = [];
        const now = new Date();

        if (period === 'month') {
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            labels = Array.from({ length: daysInMonth }, (_, i) => i + 1 + "Test");
            dataDownloads = Array.from({ length: daysInMonth }, () => Math.floor(Math.random() * 20) + 1);
            dataViews = Array.from({ length: daysInMonth }, () => Math.floor(Math.random() * 20) + 1);
        } else if (period === 'year') {
            labels = Array.from({ length: 12 }, (_, i) => new Date(0, i).toLocaleString('default', { month: 'short' }));
            dataDownloads = Array.from({ length: 12 }, () => Math.floor(Math.random() * 100) + 1);
            dataViews = Array.from({ length: 12 }, () => Math.floor(Math.random() * 100) + 1);
        }
        console.log(labels, dataDownloads, dataViews)
        return { labels, dataDownloads, dataViews };
    };

    const updateChart = (period) => {
        const { labels, dataDownloads, dataViews } = period;

        chart.data.labels = labels;
        chart.data.datasets[0].data = dataDownloads;
        chart.data.datasets[2].data = dataViews;
        chart.update();
    };
</script>